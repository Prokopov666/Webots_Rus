## Использование Makefiles в Webots

### Что такое Makefiles


В Webots компиляция контроллеров на C/C++ или Java может быть настроена с помощью Makefiles. 
Makefile контроллера - конфигурационный фаил, используемый утилитой `make`, который также может задавать список файлов-источников, связи между ними  и то, как они будут компилированы при создании исполняемой программы. 

Обратите внимание, что Python и *MATLAB*<sup>TM</sup> это интерпретируемые языки, и поэтому не требуют наличия Makefiles. Следовательно, при использовании этих языков или Visual Studio вы можете пропустить этот раздел.

При использовании C/C++ или Java необходимо наличие Makefile в директории контроллера. Если Makefile отсутствует в директории контроллера, то Webots автоматически предложит его создать. Этот Makefile может быть отредактирован с помощью текстового редактора; Задача Makefile в том, чтобы определить специфичные для проекта переменные и подключить глобальный файл "Makefile.include". Глобальный файл "Makefile.include" хранится в директории "WEBOTS_HOME/resources/"; Он содержит действующие правила сборки и может отличаться в зависимости от версии Webots. Обратите внимание, что Makefiles не зависят от платформы и языка.


### Контроллер с несколькими файлами-источниками(C/C++)

Если контроллеру требуется несколько файлов-источников C/C++, их необходимо указать в Makefile. Имя каждого файла-источника должно быть указано с использованием одной из следующих переменных:

%figure "Webots Makefile Sources Variables"

| Переменные      | Использование                                                |
| ------------ | ---------------------------------------------------- |
| C\_SOURCES   | определяет список файлов-источников с расширением .c                |
| CXX\_SOURCES | определяет список файлов-источников с расширениями  .cpp, *.cc или *.c++  |

%end

Каждый фаил-источник, опредленный с помощью этих переменных, будет добавлен в сборку контроллера. Кроме того, файлы зависимостей будут автоматически сгенерированы утилитой `make`, чтобы минимизировать сборку. 
Обратите внимание, что эти переменные должны содержать только код C или C++.

Например, если контроллер имеет несколько файлов-источников с расширением .c, то это может быть отражено в Makefile контроллера следующим образом:
```makefile
C_SOURCES = my_controller.c my_second_file.c my_third_file.c
```

Если проект имеет несколько файлов-источников с расширением .cpp, то это может быть обозначено, например, так: 

```makefile
CXX_SOURCES = my_controller.cpp my_second_file.cpp my_third_file.cc
```

Важно: правила сборки требуют, чтобы один из исходных файлов в списке соответствовал имени контроллера (т.е. имени директории контроллера), так, если директория контроллера называется  "my_controller", то список должен содержать "my_controller.c, my_controller.cpp" или "my_controller.cc" соответственно.

### Использование флагов компилятора и компоновщика (C/C++)

Следующие переменные могут использоваться для передачи флагов компилятору или компоновщику gcc:

%figure "Webots Makefile Compiler Variables"

| Переменная   | Использование                                                                                                      |
| --------- | ---------------------------------------------------------------------------------------------------------- |
| CFLAGS    |  Определяет список флагов, которые будут переданы компилятору gcc/g++                                 |
| LFLAGS    | Определяет список флагов, которые будут переданы компоновщику                                               |
| INCLUDE   | Определяет директории, которые будут добавлены в список мест, просматриваемых компилятором gcc/g++ для включения фалов |
| LIBRARIES | Определяет библиотеки переданные компоновщику и  директории, в которых будет осуществлен их поиск                                     |

%end
   
#### Добавление сторонней библиотеки (C/C++)

C/C++ контроллеры Webots это обыкновенные двоичные исполняемые файлы, которые могут быть легко компилированы и скомпонованы со сторонними библиотеками.
Чтобы добавить сторонние библиотеки необходимо определить в Makefile контроллера пути к заголовочным файлам и библиотеке, а также ее имя .
Например, чтобы указать директорию для поиска включенных файлов, можно добавить флаг `-I`*dir* в переменную INCLUDE.
Переменная LIBRARIES может использоваться для передачи флагов компоновщику.
Например, флаг  `-L`*dir* может быть использован для того, чтобы добавить директорию для поиска статических или динамических библиотек, а флаг `-l` может быть использован для того, чтобы определить имя библиотеки, которую необходимо скомпоновать с контроллером.

Например, давайте предположим, что вы хотели бы добавить внешнюю библиотеку с именем *XYZLib*.
Также, предположим, что заголовочные файлы и файл ".dll" этой библиотеки расположены в следующей директории(Windows): 

```
C:\Users\YourName\XYZLib\include\XYZLib.h
C:\Users\YourName\XYZLib\lib\XYZLib.dll
```

Тогда, это должно быть отражено в Makefile следующим образом: 

```makefile
INCLUDE = -I"C:\Users\YourName\XYZLib\include"
LIBRARIES = -L"C:\Users\YourName\XYZLib\lib" -lXYZLib
```
Первая строка указывает, где gcc должен искать файл *#include<XYZLib.h>*.
Вторая строка указывает gcc скомпоновать исполняемый контроллер с файлом "XYZLib.dll" и где этот ".dll" файл может быть найден.
Заметьте, что на Linux и macOS это будет выглядеть аналогичным образом, необходимо будет только использовать UNIX-совместимый путь. 
Если необходимо использовать другие сторонние библиотеки, то всегда возможно использование дополнительных флагов `-I, -L` и `-l`.
Для получения более подробной информацией об использовании этих флагов, обратитесь к справочной информации по `gcc`.


Переменная CFLAGS эквивалентна INCLUDE. Однако, рекомендуется использовать переменную INCLUDE для добавления используемых директорий, а переменную CFLAGS для других настроек компиляции.
Аналогично, LFLAGS эквивалентна LIBRARIES, но переменная LFLAGS добавляется в команду компоновщика перед переменной LIBRARIS, и поэтому предлагается использовать переменную LFLAGS для любых изменений параметров компоновки, кроме изменения списка используемых библиотек.
Вы можете найти список параметров компилятора и компоновщика на [сайте gcc](https://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html#Option-Summary).


#### Использование C API в C++ контроллере

Обычно в Webots, контроллеры на C++ используют C++ API.
C++ API это набор классов C++, содержащихся в заголовочных файлах C++, например `#include <webots/Robot.hpp>`.
При желании, контроллеры на C++ могут использовать C API.
C API это набор функций C начинающихся с префикса `wb` и содержащихся в заголовочных файлах C, например `#include <webots/robot.h>`.
Чтобы использовать C API в контроллере на C++ необходимо добавить следующую строку в Makefile контроллера.

```makefile
USE_C_API = true
```

#### Подробные сведения о компиляция

Имеется возможность вывести подробную информацию о выполненной последовательности команд, поместив в переменную VERBOSE, находящуюся внутри Makefile контроллера, непустое значение:

```makefile
VERBOSE = 1
```

#### Добавление информации об отладке ДОДЕЛАТЬ!!!

Если вам необходимо провести отладку контроллера, то вам следует рекомпилировать его в терминале, используя метку `debug` :


```sh
make debug
```

Это сообщит gcc добавить отладочную информацию таким образом, чтобы стало возможно отладить исполняемый фаил используя gcc.
