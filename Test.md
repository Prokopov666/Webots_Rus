## Использование Makefiles в Webots

### Что такое Makefiles

Компиляция C/C++ или Java контроллеров Webots может быть настроена с помощью Makefiles. Makefile контроллера - конфигурационный фаил используемый утилитой `make`, который также может определять список файлов источников, как они будут компилироваться и как они связаны, для создания исполняемой программы.

Обратите внимание, что Python и *MATLAB*<sup>TM</sup> интерпретируемые языки, поэтому они не требуют наличия Makefiles. Так что при использовании этих языков или Visual Studio вы можете пропустить этот раздел.

При использовании C/C++ или Java наличие Makefile в директории контроллера необходимо. Если Makefile отсутствует в директории контроллера, то Webots автоматически предложит его создать. Этот Makefile может быть отредактирован с помощью текстового редактора; Задача Makefile в том чтобы определить специфичные для проекта переменные и подключить глобальный фаил "Makefile.include". Глобальный фаил "Makefile.include" хранится в директории "WEBOTS_HOME/resources/"; Он содержит действующие правила сборки и может отличаться в зависимости от версии Webots. Обратите внимание, что Makefile не зависят от платформы и языка.


### Контроллер с несколькими файлами-источниками(C/C++)

Если контроллеру требуется несколько файлов-источников C/C++, их необходимо указать в Makefile. Имя каждого файла-источника должно быть указано в списке с использованием одной из следующих переменных:

%figure "Webots Makefile Sources Variables"

| Переменные      | Использование                                                |
| ------------ | ---------------------------------------------------- |
| C\_SOURCES   | определяет список .c исходных файлов                 |
| CXX\_SOURCES | определяет список .cpp, *.cc или *.c++ исходных файлов   |

%end

Каждый фаил-источник, опредленный с помощью этих переменных, будет добавлен в сборку контроллера. Кроме того, файлы зависимостей будут автоматически сгенерированы утилитой `make`, чтобы минимизировать сборку. 
Обратите внимание, что эти переменные не должны использоваться ни на каком другом языке, кроме C или C++.

Например, если контроллер имеет несколько .c исходных файлов, то это может быть отражено в файле Makefile контроллера следующим образом:
```makefile
C_SOURCES = my_controller.c my_second_file.c my_third_file.c
```

Если проект имеет несколько .cpp исходных файлов, то это может быть определено, например так: 

```makefile
CXX_SOURCES = my_controller.cpp my_second_file.cpp my_third_file.cc
```

Важно: правила сборки требуют, чтобы один из исходных файлов в списке соответствовал имени контроллера (т.е. имени директории контроллера), так, 
если директория контроллера называется  "my_controller", то список должен содержать "my_controller.c, my_controller.cpp" или "my_controller.cc" соответственно.

### Using the Compiler and Linker Flags (C/C++)

Следующие переменные могут использоваться для передачи флагов компилятору или компоновщику gcc:

%figure "Webots Makefile Compiler Variables"

| Переменная   | Использование                                                                                                      |
| --------- | ---------------------------------------------------------------------------------------------------------- |
| CFLAGS    |  Определяет список флагов, которые будут переданы компилятору gcc/g++                                 |
| LFLAGS    | Определяет список флагов, которые будут переданы компоновщику                                               |
| INCLUDE   | Определяет директории, которые будут добавлены в список мест, просматриваемых компилятором gcc/g++ для включения фалов |
| LIBRARIES | Определяет библиотеки переданные компоновщику и  директории, в которых будет осуществлен их поиск                                     |

%end

#### Добавление сторонной библиотеки (C/C++)

C/C++ контроллеры Webots это обычные двоичные исполняемые файлы, которые могут быть простым образом скомпилированы и скомпонованы со сторонними библиотеками.
Чтобы добавить сторонние библиотеки необходимо определить путь к заголовочным файлам, путь к библиотеке и ее имя в файле Makefile контроллера.
Например, чтобы указать директорию для поиска включенных файлов, можно добавить флаг `-I`*dir* в переменную INCLUDE.
Переменная LIBRARIES может использоваться для передачи флагов компоновщику.
Например, флаг  `-L`*dir* может быть использован для того чтобы добавить директорию для поиска статических или динамических библиотек, также флаг `-l` может быть использован для того, чтобы определить имя библиотеки, которую необходимо скомпоновать с контроллером.

Например, давайте предположим, что вы хотели бы добавить внешнюю библиотеку с именем *XYZLib*.
Также предположим, что заголовочные файлы и файл ".dll" этой библиотеки расположены в следующей директории(Windows): 

```
C:\Users\YourName\XYZLib\include\XYZLib.h
C:\Users\YourName\XYZLib\lib\XYZLib.dll
```

Тогда, это должно быть отражено в файле Makefile следующим образом: 

```makefile
INCLUDE = -I"C:\Users\YourName\XYZLib\include"
LIBRARIES = -L"C:\Users\YourName\XYZLib\lib" -lXYZLib
```
Первая строка указывает, где gcc должен искать файл *#include<XYZLib.h>*.
Вторая строка указывает gcc скомпоновать исполняемый контроллер с файлом "XYZLib.dll" и где этот ".dll" файл может быть найден.
Заметьте, что это будет аналогичным образом выглядеть на Linux и macOS, необходимо будет только использовать UNIX-совместимый путь. 
Если необходимо использовать другие сторонние библиотеки, то всегда возможно использовать дополнительные флаги `-I, -L` и `-l`.
За более подробной информацией об использовании этих флагов, обратитесь к справочной информации по `gcc`.

Хотя переменная CFLAGS эквивалентна INCLUDE, рекомендуется использовать ее для задания параметров компиляции gcc/g++, отличных от добавления включенных директорий.
Аналогично, LFLAGS эквивалентна LIBRARIES, но переменная LFLAGS добавляется в команду компоновщика перед переменной LIBRARIS и предлагается использование переменной LFLAGS !!!!!!!!!!!!!!!!!!!.
Вы можете найти список параметров компилятора и компоновщика на [сайте gcc](https://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html#Option-Summary).


#### Использование C API в C++ контроллере

Обычно, C++ контроллеры используют Webots C++ API.
C++ API это набор классов C++ содержащихся в заголовочных файлах C++, например `#include <webots/Robot.hpp>`.
При желании, C++ контроллеры могут использовать Webots C API.
C API это набор функций C начинающихся с префикса `wb` и содержащиеся в заголовочных файлах C, например `#include <webots/robot.h>`.
Чтобы использовать C API в C++ контроллере необходимо добавить эту линию в файл Makefile контроллера.

```makefile
USE_C_API = true
```

#### Подробная компиляция

Возможно вывести подробную информацию о исполненной последовательности команд, поместив в переменную VERBOSE непустое значение в файле Makefile контроллера:

```makefile
VERBOSE = 1
```

#### Добавление информации об отладке

Если необходимо отладить ваш контроллер, то вам необходимо рекомпилировать его следующим образом:!!!!!!!!!!!!


```sh
make debug
```

Это сообщит gcc добавить отладочную информацию таким образом чтобы стало возможно отладить исполняемый фаил использую gcc.
